#!/bin/bash

# Convierto la version a nro entero
version_to_int() {
    echo "$1" | tr -d '.'
}

# Defino las versiones afectadas por la vulnerabilidad CVE-2023-50164 (convertidas a números enteros)
vulnerable_ranges=("200-2337" "2500-25320" "6000-6301")

# Busco los archivos pom.xml que contienen la version de struts
struts_version=$(locate pom.xml | xargs grep -h "<struts2.version>" | head -n 1 | awk -F'[><]' '{print $3}')

# Verifico si la version es vulnerable
vulnerable=false
if [ -n "$struts_version" ]; then
    version_int=$(version_to_int "$struts_version")
    for range in "${vulnerable_ranges[@]}"; do
        range_min=$(echo "$range" | cut -d'-' -f1)
        range_max=$(echo "$range" | cut -d'-' -f2)
        if (( version_int >= range_min && version_int <= range_max )); then
            vulnerable=true
            vulnerable_version=$struts_version
            break
        fi
    done
fi

if [ "$vulnerable" = true ]; then
    echo "Se ha detectado una versión vulnerable de Apache Struts ($vulnerable_version)."
    echo "Se recomienda actualizar a una versión segura (Struts 2.5.33 o Struts 6.3.0.2 o superior) para resolver esta vulnerabilidad."
else
    echo "No se ha detectado ninguna versión vulnerable de Apache Struts."
fi
