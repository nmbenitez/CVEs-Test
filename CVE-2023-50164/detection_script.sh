#!/bin/bash

# Convert the version to integer
version_to_int() {
    echo "$1" | tr -d '.'
}

# Define the versions affected by the vulnerability CVE-2023-50164 (converted to integers)
vulnerable_ranges=("200-2337" "2500-25320" "6000-6301")

# Looking for the pom.xml files containing the struts version
struts_version=$(locate pom.xml | xargs grep -h "<struts2.version>" | head -n 1 | awk -F'[><]' '{print $3}')

# Check if the version is vulnerable
vulnerable=false
if [ -n "$struts_version" ]; then
    version_int=$(version_to_int "$struts_version")
    for range in "${vulnerable_ranges[@]}"; do
        range_min=$(echo "$range" | cut -d'-' -f1)
        range_max=$(echo "$range" | cut -d'-' -f2)
        if (( version_int >= range_min && version_int <= range_max )); then
            vulnerable=true
            vulnerable_version=$struts_version
            break
        fi
    done
fi

if [ "$vulnerable" = true ]; then
    echo "A vulnerable version of Apache Struts ($vulnerable_version) has been detected."
    echo "It is recommended to upgrade to a secure version (Struts 2.5.33 or Struts 6.3.0.2 or higher) to resolve this vulnerability."
else
    echo "No vulnerable version of Apache Struts has been detected."
fi
