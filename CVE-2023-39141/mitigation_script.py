#!/usr/bin/env python3

# Ruta al archivo node-server.js
node_server_path = "/home/kali/webui-aria2/node-server.js"

# Path Traversal Prevention
path_traversal_prev = '''
// Path Traversal Prevention
var cwdir = path.join(process.cwd(), "docs");
if (filename.indexOf(cwdir) !== 0) {
    response.writeHead(400, { "Content-Type": "text/plain" });
    response.write("Caracteres no permitidos en el nombre del archivo\\n");
    response.end();
    return;
}
// End Fix Path Traversal Prevention
'''

with open(node_server_path, 'r') as file:
    content = file.readlines()

# Buscar la posición para insertar la lógica de whitelisting
match = 'path.join(process.cwd()'
for i, line in enumerate(content):
    if match in line:
        insert_index = i + 1
        break
else:
    raise ValueError(f"No se encontró la cadena de coincidencia: {match}")

content.insert(insert_index, path_traversal_prev)

# Escribo el contenido modificado en el archivo
with open(node_server_path, 'w') as file:
    file.writelines(content)

print(f"Se agrego la prevencion al Path Traversal en {node_server_path}")
