#!/bin/bash

# Este script tiene la finalidad de detectar la vulnerabilidad CVE-2023-39141
detect_vulnerability() {
    # Solicitar al usuario la ruta de instalación del servidor WebUI-Aria2
    read -p "Ingrese la ruta de instalación del servidor WebUI-Aria2 (ruta completa al directorio donde se encuentra node-server.js): " webui_path

    # Comprobar si el archivo node-server.js existe en la ruta proporcionada
    if [ -f "$webui_path/node-server.js" ]; then
        # Comprobar si el archivo node-server.js contiene la línea vulnerable
        if grep -q "filename = path.join(process.cwd(), \"docs\", uri);" "$webui_path/node-server.js"; then
            # Comprobar si la vulnerabilidad ya ha sido mitigada
            if grep -q "filename.indexOf(cwdir)" "$webui_path/node-server.js"; then
                echo "La vulnerabilidad CVE-2023-39141 ha sido mitigada en $webui_path/node-server.js"
            else
                echo "La vulnerabilidad CVE-2023-39141 ha sido detectada en $webui_path/node-server.js"
                # Preguntar al usuario si desea mitigar la vulnerabilidad
                read -p "¿Desea mitigar la vulnerabilidad? (s/n): " response
                if [ "$response" = "s" ]; then
                    # Ejecutar el script de mitigación
                    python3 mit-script.py
                fi
            fi
        else
            echo "No se encontraron indicios de la vulnerabilidad CVE-2023-39141 en $webui_path/node-server.js"
        fi
    else
        echo "El archivo node-server.js no fue encontrado en la ruta proporcionada: $webui_path"
    fi
}

# Llamar a la función de detección
detect_vulnerability